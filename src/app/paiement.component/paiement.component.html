<app-sidebar></app-sidebar>

<div class="ml-72 p-6">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">Mes factures</h2>

    <!-- Barre de recherche et filtre -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <input type="text" placeholder="Rechercher une facture..." [(ngModel)]="searchTerm" class="input-wrapper w-full md:w-1/3" />

        <select [(ngModel)]="filterStatus" class="input-wrapper w-full md:w-1/4">
      <option value="">Tous les statuts</option>
      <option value="EN_ATTENTE">En attente</option>
      <option value="SUCCES">Payé</option>
      <option value="ECHEC">Échec</option>
    </select>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
        <div class="payment-card text-center p-4">
            <p class="text-gray-500">Total facturé</p>
            <p class="text-2xl font-bold text-gray-800">{{ totalFactures | number:'1.0-0' }} XOF</p>
        </div>
        <div class="payment-card text-center p-4">
            <p class="text-gray-500">Total payé</p>
            <p class="text-2xl font-bold text-green-600">{{ totalPaye | number:'1.0-0' }} XOF</p>
        </div>
        <div class="payment-card text-center p-4">
            <p class="text-gray-500">Reste à payer</p>
            <p class="text-2xl font-bold text-yellow-600">{{ totalRestant | number:'1.0-0' }} XOF</p>
        </div>
    </div>

    <!-- Cartes factures -->
    <div *ngIf="factures.length > 0; else noFactures" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div *ngFor="let f of filteredFactures()" class="payment-card animate-fadeInUp relative">

            <!-- Header -->
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-700">{{ f.numero }}</h3>
                <span class="text-sm text-gray-500">{{ f.dateEmission | date:'dd/MM/yyyy' }}</span>
            </div>

            <!-- Montant -->
            <div class="mb-2">
                <p class="text-gray-600">Montant total :</p>
                <p class="font-bold text-gray-800 text-lg">
                    {{ f.paiement?.montant ? (f.paiement.montant | number:'1.0-0') + ' XOF' : 'En attente' }}
                </p>
            </div>

            <!-- Montant à régler -->
            <div class="mb-3">
                <label class="block text-gray-600 mb-1">Montant à régler</label>
                <input *ngIf="f.paiement" type="number" [(ngModel)]="f.montantASolder" [max]="f.paiement?.montant || 0" min="1" class="input-wrapper w-full" placeholder="Entrez le montant" />
                <span *ngIf="!f.paiement" class="text-gray-400 italic">N/A</span>
            </div>

            <!-- Méthode de paiement -->
            <div class="mb-4">
                <label class="block text-gray-600 mb-1">Méthode de paiement</label>
                <select *ngIf="f.paiement" [(ngModel)]="f.methode" class="input-wrapper w-full">
          <option value="Wave">Wave</option>
          <option value="Orange Money">Orange Money</option>
        </select>
                <span *ngIf="!f.paiement" class="text-gray-400 italic">N/A</span>
            </div>

            <!-- Action et statut -->
            <div class="flex flex-col gap-2">
                <button class="btn-primary w-full" (click)="initierPaiement(f)" [disabled]="!f.paiement || !f.montantASolder || f.montantASolder <= 0">
          Régler
        </button>

                <span *ngIf="!f.paiement" class="text-gray-500 italic text-sm text-center">En attente de paiement</span>

                <span *ngIf="f.paiement && paiementDetails?.id === f.paiement.id" class="payment-status mt-1 text-center" [ngClass]="{
                'success': paiementStatus === 'SUCCES',
                'error': paiementStatus === 'ECHEC',
                'pending': paiementStatus === 'EN_ATTENTE'
              }">
          {{ paiementStatus || 'En attente' }}
        </span>
            </div>
        </div>
    </div>

    <ng-template #noFactures>
        <p class="text-gray-600 italic mt-6 text-center">Aucune facture disponible.</p>
    </ng-template>
</div>

<!-- Modal QR -->
<div *ngIf="showQrModal" class="qr-modal">
    <div class="glass-card qr-modal-content animate-fadeInUp">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Scanner pour payer</h3>
        <p class="text-gray-600 mb-6 text-sm">
            Utilisez votre application Wave ou Orange Money pour scanner le QR code ci-dessous.
        </p>
        <div class="flex justify-center mb-6">
            <app-qr-code *ngIf="qrCodeData" [value]="qrCodeData"></app-qr-code>
        </div>
        <div class="flex justify-center gap-4 w-full">
            <button (click)="closeQrModal()" class="btn-secondary flex-1">
        Fermer
      </button>
            <a *ngIf="qrCodeData" [href]="qrCodeData" target="_blank" class="btn-primary flex-1">
        Ouvrir dans l’app
      </a>
        </div>
    </div>
</div>